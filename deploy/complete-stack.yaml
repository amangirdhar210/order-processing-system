AWSTemplateFormatVersion: '2010-09-09'
Description: 'Order Processing System - Complete Infrastructure'

Parameters:
  SESFromEmail:
    Type: String
    Description: SES verified email address
    Default: noreply@amangirdhar.me

Resources:
  OrderProcessingTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: order-processing-system
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      Tags:
        - Key: Application
          Value: OrderProcessing

  OrderEventsTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: order-events
      DisplayName: Order Processing Events
      Tags:
        - Key: Application
          Value: OrderProcessing

  OrderEventsDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: order-events-dlq
      MessageRetentionPeriod: 1209600
      Tags:
        - Key: Application
          Value: OrderProcessing

  OrderEventsQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: order-events
      VisibilityTimeout: 300
      MessageRetentionPeriod: 1209600
      ReceiveMessageWaitTimeSeconds: 20
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt OrderEventsDeadLetterQueue.Arn
        maxReceiveCount: 3
      Tags:
        - Key: Application
          Value: OrderProcessing

  QueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref OrderEventsQueue
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: sns.amazonaws.com
            Action:
              - sqs:SendMessage
            Resource: !GetAtt OrderEventsQueue.Arn
            Condition:
              ArnEquals:
                aws:SourceArn: !Ref OrderEventsTopic

  TopicSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: sqs
      TopicArn: !Ref OrderEventsTopic
      Endpoint: !GetAtt OrderEventsQueue.Arn
      RawMessageDelivery: true

Outputs:
  DynamoDBTableName:
    Description: DynamoDB Table Name
    Value: !Ref OrderProcessingTable
    Export:
      Name: OrderProcessing-DynamoDBTableName

  SNSTopicArn:
    Description: SNS Topic ARN
    Value: !Ref OrderEventsTopic
    Export:
      Name: OrderProcessing-SNSTopicArn

  SQSQueueUrl:
    Description: SQS Queue URL
    Value: !Ref OrderEventsQueue
    Export:
      Name: OrderProcessing-SQSQueueUrl

  SQSQueueArn:
    Description: SQS Queue ARN
    Value: !GetAtt OrderEventsQueue.Arn
    Export:
      Name: OrderProcessing-SQSQueueArn

  DLQUrl:
    Description: Dead Letter Queue URL
    Value: !Ref OrderEventsDeadLetterQueue
    Export:
      Name: OrderProcessing-DLQUrl
