AWSTemplateFormatVersion: '2010-09-09'
Description: 'Order Processing System - Local Testing Resources (DynamoDB + SNS + SQS)'

Resources:
  OrderProcessingTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: order-processing-local
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE

  OrderEventsTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: order-events-local
      DisplayName: Order Events - Local Testing

  OrderEventsQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: order-events-local
      VisibilityTimeout: 300
      MessageRetentionPeriod: 1209600
      ReceiveMessageWaitTimeSeconds: 20

  QueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref OrderEventsQueue
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: sns.amazonaws.com
            Action:
              - sqs:SendMessage
            Resource: !GetAtt OrderEventsQueue.Arn
            Condition:
              ArnEquals:
                aws:SourceArn: !Ref OrderEventsTopic

  TopicSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: sqs
      TopicArn: !Ref OrderEventsTopic
      Endpoint: !GetAtt OrderEventsQueue.Arn
      RawMessageDelivery: true

Outputs:
  TableName:
    Description: DynamoDB Table Name
    Value: !Ref OrderProcessingTable

  SNSTopicArn:
    Description: SNS Topic ARN
    Value: !Ref OrderEventsTopic

  SQSQueueUrl:
    Description: SQS Queue URL
    Value: !Ref OrderEventsQueue
